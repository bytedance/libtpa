#!/bin/bash
#
# SPDX-License-Identifier: BSD-3-Clause
# Copyright (c) 2023, ByteDance Ltd. and/or its Affiliates
# Author: Yuanhan Liu <liuyuanhan.131@bytedance.com>

BUILD_MODE="release"
DPDK_VERSION="v20.11.3"
MLNX_ONLY=
DISABLE_TEST=

CFG_FILE="build/config.mk"

usage()
{
	error="$1"
	[ -n "$error" ] && echo -e "error: $error\n"

	cat << EOF
usage: ./configure [options]

Supported options are:
  --edit                         edit the config file manually
  --debug                        debug build
  --release                      release build (default)
  --asan                         asan build
  --dpdk [version]               specify dpdk version (default v20.11.3)
  --mlnx-only                    build with mlnx PMD only
  --disable-test                 do not build test
EOF

	exit 1
}

parse_options()
{
	while [ -n "$1" ]; do
		case "$1" in
		"--edit")
			if [ -f "$CFG_FILE" ]; then
				${EDITOR:-vim} $CFG_FILE
			else
				echo "error: no config file generated yet"
			fi
			exit
			;;

		"--debug")
			BUILD_MODE="debug"
			;;
		"--release")
			BUILD_MODE="release"
			;;
		"--asan")
			BUILD_MODE="asan"
			;;

		"--dpdk")
			shift
			[ -z "$1" ] && usage "missing argument for --dpdk option"
			DPDK_VERSION=$1
			;;

		"--mlnx-only")
			MLNX_ONLY="yes"
			;;

		"--disable-test")
			DISABLE_TEST="yes"
			;;

		*)
			usage
			exit 1
		esac

		shift
	done
}

gen_config()
{
	mkdir -p $(dirname $CFG_FILE)

	cat > $CFG_FILE << EOF
export BUILD_MODE   = $BUILD_MODE
export DPDK_VERSION = $DPDK_VERSION
export MLNX_ONLY    = $MLNX_ONLY
export DISABLE_TEST = $DISABLE_TEST
EOF

	echo "configs generated are:"
	echo

	cat build/config.mk | sed 's/export/ /'
}

parse_options "$@"
gen_config
